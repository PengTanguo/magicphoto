<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬æ¨æ‹‰é•œå¤´è§†é¢‘ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .panel-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            grid-column: span 2;
        }

        .upload-area {
            border: 3px dashed #764ba2;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .upload-area.dragover {
            background: #e8eaf6;
            border-color: #3f51b5;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        #fileInput {
            display: none;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .preview-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        /* å‚æ•°æ§åˆ¶é¢æ¿ */
        .parameter-group {
            margin-bottom: 25px;
        }

        .parameter-group label {
            display: block;
            color: #555;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .parameter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .parameter-row input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .parameter-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #764ba2;
            cursor: pointer;
        }

        .parameter-value {
            min-width: 80px;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group input[type="number"] {
            width: 100px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            width: 100%;
        }

        /* å…³é”®å¸§ç¼–è¾‘å™¨ */
        .keyframe-editor {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .keyframe-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .keyframe-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .keyframe-item.active {
            border-color: #764ba2;
            background: #f3e5f5;
        }

        .keyframe-item-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .keyframe-item-value {
            font-weight: bold;
            color: #333;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .progress-text {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }

        /* é¢„è®¾æ¨¡æ¿ */
        .preset-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preset-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .preset-item:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .preset-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .preset-name {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        /* ç„¦ç‚¹é€‰æ‹©å™¨ */
        .focus-selector {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-top: 10px;
            cursor: crosshair;
            overflow: hidden;
        }

        .focus-point {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #764ba2;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .focus-selector img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0.5;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }

            .upload-section {
                grid-column: span 1;
            }
        }

        /* è¾“å‡ºæ ¼å¼é€‰é¡¹ */
        .output-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        /* æ—¶é—´è½´ */
        .timeline {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .timeline-track {
            position: relative;
            height: 60px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
        }

        .timeline-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #764ba2;
            pointer-events: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="header">
        <h1>ğŸ¬ å›¾ç‰‡è½¬æ¨æ‹‰é•œå¤´è§†é¢‘ç”Ÿæˆå™¨</h1>
        <p>å°†é™æ€å›¾ç‰‡è½¬æ¢ä¸ºå…·æœ‰ç”µå½±çº§æ¨æ‹‰é•œå¤´æ•ˆæœçš„è§†é¢‘</p>
    </div>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="panel upload-section">
        <div class="panel-title">ğŸ“¸ é€‰æ‹©å›¾ç‰‡</div>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
            <div style="color: #999; font-size: 14px; margin-top: 10px;">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>
    </div>

    <div class="content-wrapper">
        <!-- å·¦ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
        <div class="panel">
            <div class="panel-title">ğŸ‘ï¸ æ•ˆæœé¢„è§ˆ</div>
            <div class="preview-container">
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
            </div>
            <div class="preview-controls">
                <button class="btn btn-secondary" onclick="playPreview()">â–¶ï¸ æ’­æ”¾é¢„è§ˆ</button>
                <button class="btn btn-secondary" onclick="pausePreview()">â¸ï¸ æš‚åœ</button>
                <button class="btn btn-secondary" onclick="resetPreview()">â¹ï¸ é‡ç½®</button>
            </div>

            <!-- æ—¶é—´è½´ -->
            <div class="timeline">
                <label>æ—¶é—´è½´</label>
                <div class="timeline-track">
                    <div class="timeline-marker" id="timelineMarker"></div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå‚æ•°æ§åˆ¶ -->
        <div class="panel">
            <div class="panel-title">âš™ï¸ å‚æ•°è®¾ç½®</div>

            <!-- é¢„è®¾æ¨¡æ¿ -->
            <div class="parameter-group">
                <label>å¿«é€Ÿé¢„è®¾</label>
                <div class="preset-templates">
                    <div class="preset-item" onclick="applyPreset('slowZoomIn')">
                        <div class="preset-icon">ğŸ”</div>
                        <div class="preset-name">ç¼“æ…¢æ¨è¿›</div>
                    </div>
                    <div class="preset-item" onclick="applyPreset('slowZoomOut')">
                        <div class="preset-icon">ğŸ”</div>
                        <div class="preset-name">ç¼“æ…¢æ‹‰è¿œ</div>
                    </div>
                    <div class="preset-item" onclick="applyPreset('kenBurns')">
                        <div class="preset-icon">ğŸ¥</div>
                        <div class="preset-name">Ken Burns</div>
                    </div>
                    <div class="preset-item" onclick="applyPreset('dramatic')">
                        <div class="preset-icon">ğŸ­</div>
                        <div class="preset-name">æˆå‰§æ•ˆæœ</div>
                    </div>
                    <div class="preset-item" onclick="applyPreset('pulse')">
                        <div class="preset-icon">ğŸ’—</div>
                        <div class="preset-name">è„‰å†²æ•ˆæœ</div>
                    </div>
                    <div class="preset-item" onclick="applyPreset('vertigo')">
                        <div class="preset-icon">ğŸŒ€</div>
                        <div class="preset-name">çœ©æ™•æ•ˆæœ</div>
                    </div>
                </div>
            </div>

            <!-- åŸºç¡€å‚æ•° -->
            <div class="parameter-group">
                <label>è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                <div class="parameter-row">
                    <input type="range" id="duration" min="1" max="30" value="5"
                           oninput="updateValue('duration', this.value)">
                    <div class="parameter-value" id="durationValue">5ç§’</div>
                </div>
            </div>

            <div class="parameter-group">
                <label>èµ·å§‹ç¼©æ”¾</label>
                <div class="parameter-row">
                    <input type="range" id="startZoom" min="50" max="200" value="100"
                           oninput="updateValue('startZoom', this.value)">
                    <div class="parameter-value" id="startZoomValue">100%</div>
                </div>
            </div>

            <div class="parameter-group">
                <label>ç»“æŸç¼©æ”¾</label>
                <div class="parameter-row">
                    <input type="range" id="endZoom" min="50" max="200" value="150"
                           oninput="updateValue('endZoom', this.value)">
                    <div class="parameter-value" id="endZoomValue">150%</div>
                </div>
            </div>

            <div class="parameter-group">
                <label>ç¼“åŠ¨æ•ˆæœ</label>
                <select id="easing">
                    <option value="linear">çº¿æ€§</option>
                    <option value="easeIn">ç¼“å…¥</option>
                    <option value="easeOut">ç¼“å‡º</option>
                    <option value="easeInOut" selected>ç¼“å…¥ç¼“å‡º</option>
                    <option value="easeInQuad">äºŒæ¬¡ç¼“å…¥</option>
                    <option value="easeOutQuad">äºŒæ¬¡ç¼“å‡º</option>
                    <option value="easeInOutQuad">äºŒæ¬¡ç¼“å…¥ç¼“å‡º</option>
                    <option value="easeInCubic">ä¸‰æ¬¡ç¼“å…¥</option>
                    <option value="easeOutCubic">ä¸‰æ¬¡ç¼“å‡º</option>
                    <option value="easeInOutCubic">ä¸‰æ¬¡ç¼“å…¥ç¼“å‡º</option>
                </select>
            </div>

            <!-- é«˜çº§å‚æ•° -->
            <div class="parameter-group">
                <label>ç„¦ç‚¹ä½ç½®</label>
                <div class="focus-selector" id="focusSelector">
                    <div class="focus-point" id="focusPoint" style="left: 50%; top: 50%;"></div>
                    <img id="focusThumbnail" style="display: none;">
                </div>
            </div>

            <div class="parameter-group">
                <label>æ°´å¹³ç§»åŠ¨</label>
                <div class="parameter-row">
                    <input type="range" id="panX" min="-50" max="50" value="0"
                           oninput="updateValue('panX', this.value)">
                    <div class="parameter-value" id="panXValue">0px</div>
                </div>
            </div>

            <div class="parameter-group">
                <label>å‚ç›´ç§»åŠ¨</label>
                <div class="parameter-row">
                    <input type="range" id="panY" min="-50" max="50" value="0"
                           oninput="updateValue('panY', this.value)">
                    <div class="parameter-value" id="panYValue">0px</div>
                </div>
            </div>

            <div class="parameter-group">
                <label>æ—‹è½¬è§’åº¦</label>
                <div class="parameter-row">
                    <input type="range" id="rotation" min="-30" max="30" value="0"
                           oninput="updateValue('rotation', this.value)">
                    <div class="parameter-value" id="rotationValue">0Â°</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¾“å‡ºè®¾ç½®é¢æ¿ -->
    <div class="panel">
        <div class="panel-title">ğŸ“¹ è¾“å‡ºè®¾ç½®</div>

        <div class="output-options">
            <div class="parameter-group">
                <label>åˆ†è¾¨ç‡</label>
                <select id="resolution">
                    <option value="1920x1080">1080p (1920Ã—1080)</option>
                    <option value="1280x720" selected>720p (1280Ã—720)</option>
                    <option value="854x480">480p (854Ã—480)</option>
                    <option value="640x360">360p (640Ã—360)</option>
                    <option value="3840x2160">4K (3840Ã—2160)</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>

            <div class="parameter-group">
                <label>å¸§ç‡ (FPS)</label>
                <select id="framerate">
                    <option value="24">24 fps</option>
                    <option value="30" selected>30 fps</option>
                    <option value="60">60 fps</option>
                    <option value="120">120 fps</option>
                </select>
            </div>

            <div class="parameter-group">
                <label>è¾“å‡ºæ ¼å¼</label>
                <select id="format">
                    <option value="webm" selected>WebM</option>
                    <option value="mp4">MP4 (éœ€è¦ç¼–ç å™¨)</option>
                    <option value="gif">GIF åŠ¨ç”»</option>
                </select>
            </div>

            <div class="parameter-group">
                <label>è§†é¢‘è´¨é‡</label>
                <select id="quality">
                    <option value="low">ä½è´¨é‡ (å¿«é€Ÿ)</option>
                    <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                    <option value="high">é«˜è´¨é‡</option>
                    <option value="ultra">è¶…é«˜è´¨é‡ (æ…¢é€Ÿ)</option>
                </select>
            </div>
        </div>

        <!-- å…³é”®å¸§ç¼–è¾‘å™¨ -->
        <div class="keyframe-editor">
            <label>å…³é”®å¸§ç¼–è¾‘</label>
            <div class="keyframe-list" id="keyframeList">
                <div class="keyframe-item active">
                    <div class="keyframe-item-header">å¼€å§‹</div>
                    <div class="keyframe-item-value">0s - 100%</div>
                </div>
                <div class="keyframe-item">
                    <div class="keyframe-item-header">ç»“æŸ</div>
                    <div class="keyframe-item-value">5s - 150%</div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="addKeyframe()">â• æ·»åŠ å…³é”®å¸§</button>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="generateVideo()" style="flex: 1;">
                ğŸ¬ ç”Ÿæˆè§†é¢‘
            </button>
            <button class="btn btn-warning" onclick="downloadFrame()">
                ğŸ“· å¯¼å‡ºå½“å‰å¸§
            </button>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ç”Ÿæˆè§†é¢‘...</div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ MediaRecorder API ç”¨äºè§†é¢‘å½•åˆ¶ -->
<script>
    // å…¨å±€å˜é‡
    let uploadedImage = null;
    let canvas = document.getElementById('previewCanvas');
    let ctx = canvas.getContext('2d');
    let isPlaying = false;
    let currentFrame = 0;
    let animationId = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    // å‚æ•°å¯¹è±¡
    let params = {
        duration: 5,
        startZoom: 100,
        endZoom: 150,
        easing: 'easeInOut',
        focusX: 0.5,
        focusY: 0.5,
        panX: 0,
        panY: 0,
        rotation: 0,
        framerate: 30,
        resolution: '1280x720',
        format: 'webm',
        quality: 'medium'
    };

    // å…³é”®å¸§æ•°ç»„
    let keyframes = [
        { time: 0, zoom: 100, x: 0, y: 0, rotation: 0 },
        { time: 5, zoom: 150, x: 0, y: 0, rotation: 0 }
    ];

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelect);

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file);
        }
    });

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file);
        }
    }

    function loadImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                uploadedImage = img;
                document.getElementById('focusThumbnail').src = e.target.result;
                document.getElementById('focusThumbnail').style.display = 'block';
                initCanvas();
                drawFrame(0);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function initCanvas() {
        const [width, height] = params.resolution.split('x').map(Number);
        canvas.width = width;
        canvas.height = height;
    }

    // ç¼“åŠ¨å‡½æ•°
    const easingFunctions = {
        linear: t => t,
        easeIn: t => t * t,
        easeOut: t => t * (2 - t),
        easeInOut: t => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
        easeInQuad: t => t * t,
        easeOutQuad: t => t * (2 - t),
        easeInOutQuad: t => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
        easeInCubic: t => t * t * t,
        easeOutCubic: t => (--t) * t * t + 1,
        easeInOutCubic: t => t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1
    };

    // ç»˜åˆ¶å¸§
    function drawFrame(progress) {
        if (!uploadedImage) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // åº”ç”¨ç¼“åŠ¨
        const easedProgress = easingFunctions[params.easing](progress);

        // è®¡ç®—å½“å‰å€¼
        const currentZoom = params.startZoom + (params.endZoom - params.startZoom) * easedProgress;
        const currentPanX = params.panX * easedProgress;
        const currentPanY = params.panY * easedProgress;
        const currentRotation = params.rotation * easedProgress;

        // ä¿å­˜çŠ¶æ€
        ctx.save();

        // è®¾ç½®å˜æ¢
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(currentRotation * Math.PI / 180);
        ctx.scale(currentZoom / 100, currentZoom / 100);
        ctx.translate(currentPanX, currentPanY);

        // ç»˜åˆ¶å›¾ç‰‡
        const scale = Math.max(canvas.width / uploadedImage.width,
                               canvas.height / uploadedImage.height);
        const w = uploadedImage.width * scale;
        const h = uploadedImage.height * scale;
        ctx.drawImage(uploadedImage, -w/2, -h/2, w, h);

        // æ¢å¤çŠ¶æ€
        ctx.restore();

        // æ›´æ–°æ—¶é—´è½´æ ‡è®°
        updateTimelineMarker(progress);
    }

    // é¢„è§ˆæ§åˆ¶
    function playPreview() {
        if (!uploadedImage || isPlaying) return;

        isPlaying = true;
        const startTime = performance.now();
        const duration = params.duration * 1000;

        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            drawFrame(progress);

            if (progress < 1 && isPlaying) {
                animationId = requestAnimationFrame(animate);
            } else {
                isPlaying = false;
                if (progress >= 1) {
                    setTimeout(resetPreview, 500);
                }
            }
        }

        animationId = requestAnimationFrame(animate);
    }

    function pausePreview() {
        isPlaying = false;
        if (animationId) {
            cancelAnimationFrame(animationId);
        }
    }

            function resetPreview() {
            pausePreview();
            drawFrame(0);
            updateTimelineMarker(0);
        }

        // æ›´æ–°æ—¶é—´è½´æ ‡è®°
        function updateTimelineMarker(progress) {
            const marker = document.getElementById('timelineMarker');
            marker.style.left = (progress * 100) + '%';
        }

        // å‚æ•°æ›´æ–°
        function updateValue(param, value) {
            params[param] = parseFloat(value);

            // æ›´æ–°æ˜¾ç¤º
            const displayElement = document.getElementById(param + 'Value');
            if (displayElement) {
                let displayValue = value;
                if (param.includes('Zoom')) displayValue = value + '%';
                else if (param === 'duration') displayValue = value + 'ç§’';
                else if (param === 'rotation') displayValue = value + 'Â°';
                else if (param === 'panX' || param === 'panY') displayValue = value + 'px';
                displayElement.textContent = displayValue;
            }

            // å®æ—¶é¢„è§ˆ
            if (uploadedImage && !isPlaying) {
                drawFrame(0);
            }

            // æ›´æ–°å…³é”®å¸§æ˜¾ç¤º
            updateKeyframeDisplay();
        }

        // ç„¦ç‚¹é€‰æ‹©å™¨
        const focusSelector = document.getElementById('focusSelector');
        focusSelector.addEventListener('click', (e) => {
            const rect = focusSelector.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;

            params.focusX = x;
            params.focusY = y;

            const focusPoint = document.getElementById('focusPoint');
            focusPoint.style.left = (x * 100) + '%';
            focusPoint.style.top = (y * 100) + '%';
        });

        // é¢„è®¾æ¨¡æ¿
        const presets = {
            slowZoomIn: {
                duration: 8,
                startZoom: 100,
                endZoom: 180,
                easing: 'easeInOut',
                panX: 0,
                panY: 0,
                rotation: 0
            },
            slowZoomOut: {
                duration: 8,
                startZoom: 150,
                endZoom: 80,
                easing: 'easeInOut',
                panX: 0,
                panY: 0,
                rotation: 0
            },
            kenBurns: {
                duration: 10,
                startZoom: 100,
                endZoom: 130,
                easing: 'easeInOutCubic',
                panX: 30,
                panY: -20,
                rotation: 2
            },
            dramatic: {
                duration: 5,
                startZoom: 80,
                endZoom: 200,
                easing: 'easeInCubic',
                panX: 0,
                panY: 0,
                rotation: -5
            },
            pulse: {
                duration: 3,
                startZoom: 90,
                endZoom: 110,
                easing: 'easeInOut',
                panX: 0,
                panY: 0,
                rotation: 0
            },
            vertigo: {
                duration: 6,
                startZoom: 150,
                endZoom: 80,
                easing: 'easeInOutQuad',
                panX: 0,
                panY: -30,
                rotation: 10
            }
        };

        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;

            // åº”ç”¨é¢„è®¾å€¼
            Object.keys(preset).forEach(key => {
                params[key] = preset[key];

                // æ›´æ–°UIæ§ä»¶
                const element = document.getElementById(key);
                if (element) {
                    element.value = preset[key];
                    updateValue(key, preset[key]);
                }
            });

            // é‡æ–°ç»˜åˆ¶
            if (uploadedImage) {
                drawFrame(0);
            }
        }

        // å…³é”®å¸§ç®¡ç†
        function addKeyframe() {
            const time = prompt('è¾“å…¥å…³é”®å¸§æ—¶é—´ï¼ˆç§’ï¼‰ï¼š', '2.5');
            if (time === null) return;

            const zoom = prompt('è¾“å…¥ç¼©æ”¾æ¯”ä¾‹ï¼ˆ%ï¼‰ï¼š', '125');
            if (zoom === null) return;

            keyframes.push({
                time: parseFloat(time),
                zoom: parseFloat(zoom),
                x: params.panX,
                y: params.panY,
                rotation: params.rotation
            });

            keyframes.sort((a, b) => a.time - b.time);
            updateKeyframeDisplay();
        }

        function updateKeyframeDisplay() {
            const list = document.getElementById('keyframeList');
            list.innerHTML = keyframes.map((kf, index) => `
                <div class="keyframe-item ${index === 0 ? 'active' : ''}" onclick="selectKeyframe(${index})">
                    <div class="keyframe-item-header">${index === 0 ? 'å¼€å§‹' : index === keyframes.length - 1 ? 'ç»“æŸ' : 'å…³é”®å¸§ ' + index}</div>
                    <div class="keyframe-item-value">${kf.time}s - ${kf.zoom}%</div>
                </div>
            `).join('');
        }

        function selectKeyframe(index) {
            const kf = keyframes[index];
            if (!kf) return;

            // è·³è½¬åˆ°è¯¥å…³é”®å¸§
            const progress = kf.time / params.duration;
            drawFrame(progress);

            // é«˜äº®é€‰ä¸­çš„å…³é”®å¸§
            document.querySelectorAll('.keyframe-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.keyframe-item')[index].classList.add('active');
        }

        // ç”Ÿæˆè§†é¢‘
        async function generateVideo() {
            if (!uploadedImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.style.display = 'block';
            progressText.textContent = 'æ­£åœ¨å‡†å¤‡ç”Ÿæˆè§†é¢‘...';

            try {
                // è®¾ç½®ç”»å¸ƒå¤§å°
                const [width, height] = params.resolution.split('x').map(Number);
                canvas.width = width;
                canvas.height = height;

                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                const stream = canvas.captureStream(params.framerate);

                // é€‰æ‹©ç¼–ç å™¨
                let mimeType = 'video/webm;codecs=vp9';
                if (params.format === 'mp4') {
                    // æ³¨æ„ï¼šå¤§å¤šæ•°æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥å½•åˆ¶MP4
                    if (MediaRecorder.isTypeSupported('video/mp4')) {
                        mimeType = 'video/mp4';
                    } else {
                        alert('æµè§ˆå™¨ä¸æ”¯æŒMP4æ ¼å¼ï¼Œå°†ä½¿ç”¨WebMæ ¼å¼');
                        mimeType = 'video/webm;codecs=vp9';
                    }
                }

                // è®¾ç½®æ¯”ç‰¹ç‡
                const bitrates = {
                    low: 1000000,      // 1 Mbps
                    medium: 2500000,   // 2.5 Mbps
                    high: 5000000,     // 5 Mbps
                    ultra: 10000000    // 10 Mbps
                };

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrates[params.quality]
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    // åˆ›å»ºè§†é¢‘æ–‡ä»¶
                    const blob = new Blob(recordedChunks, {
                        type: mimeType.split(';')[0]
                    });

                    // ä¸‹è½½è§†é¢‘
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `zoom_effect_${Date.now()}.${params.format === 'mp4' ? 'mp4' : 'webm'}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    progressContainer.style.display = 'none';
                    alert('è§†é¢‘ç”Ÿæˆå®Œæˆï¼');
                };

                // å¼€å§‹å½•åˆ¶
                mediaRecorder.start();
                progressText.textContent = 'æ­£åœ¨å½•åˆ¶è§†é¢‘...';

                // æ¸²æŸ“è§†é¢‘å¸§
                const totalFrames = params.duration * params.framerate;
                let currentFrame = 0;

                function renderFrame() {
                    if (currentFrame < totalFrames) {
                        const progress = currentFrame / totalFrames;
                        drawFrame(progress);

                        // æ›´æ–°è¿›åº¦
                        const percentage = Math.round(progress * 100);
                        progressFill.style.width = percentage + '%';
                        progressFill.textContent = percentage + '%';
                        progressText.textContent = `æ­£åœ¨ç”Ÿæˆè§†é¢‘... (å¸§ ${currentFrame + 1}/${totalFrames})`;

                        currentFrame++;
                        setTimeout(renderFrame, 1000 / params.framerate);
                    } else {
                        // å½•åˆ¶å®Œæˆ
                        mediaRecorder.stop();
                        progressText.textContent = 'æ­£åœ¨ä¿å­˜è§†é¢‘...';
                    }
                }

                renderFrame();

            } catch (error) {
                console.error('ç”Ÿæˆè§†é¢‘å¤±è´¥ï¼š', error);
                alert('ç”Ÿæˆè§†é¢‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒç›¸å…³åŠŸèƒ½ã€‚');
                progressContainer.style.display = 'none';
            }
        }

        // å¯¼å‡ºå½“å‰å¸§
        function downloadFrame() {
            if (!uploadedImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `frame_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // å¦‚æœéœ€è¦GIFæ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨gif.jsåº“
        async function generateGIF() {
            if (!uploadedImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            alert('GIFç”ŸæˆåŠŸèƒ½éœ€è¦é¢å¤–çš„åº“æ”¯æŒã€‚å»ºè®®ä½¿ç”¨WebMæ ¼å¼ï¼Œç„¶åä½¿ç”¨å¤–éƒ¨å·¥å…·è½¬æ¢ä¸ºGIFã€‚');

            // å¦‚æœé›†æˆgif.jsåº“ï¼Œå¯ä»¥è¿™æ ·å®ç°ï¼š
            /*
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: canvas.width,
                height: canvas.height
            });

            const totalFrames = params.duration * 10; // GIFé€šå¸¸ä½¿ç”¨è¾ƒä½çš„å¸§ç‡

            for (let i = 0; i < totalFrames; i++) {
                const progress = i / totalFrames;
                drawFrame(progress);
                gif.addFrame(canvas, { delay: 100 }); // 100ms per frame = 10fps
            }

            gif.on('finished', (blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zoom_effect_${Date.now()}.gif`;
                a.click();
                URL.revokeObjectURL(url);
            });

            gif.render();
            */
        }

        // æ·»åŠ æ‰¹é‡å¤„ç†åŠŸèƒ½
        function batchProcess() {
            // å¯ä»¥æ‰©å±•ä¸ºæ‰¹é‡å¤„ç†å¤šå¼ å›¾ç‰‡
            alert('æ‰¹é‡å¤„ç†åŠŸèƒ½å¯ä»¥é€šè¿‡å¾ªç¯å¤„ç†å¤šä¸ªæ–‡ä»¶æ¥å®ç°ã€‚');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateKeyframeDisplay();

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && uploadedImage) {
                    e.preventDefault();
                    if (isPlaying) {
                        pausePreview();
                    } else {
                        playPreview();
                    }
                }
            });
        });

        // æ·»åŠ å®æ—¶é¢„è§ˆæ›´æ–°
        ['duration', 'startZoom', 'endZoom', 'panX', 'panY', 'rotation'].forEach(param => {
            const element = document.getElementById(param);
            if (element) {
                element.addEventListener('input', () => {
                    if (uploadedImage && !isPlaying) {
                        drawFrame(0);
                    }
                });
            }
        });

        // ç›‘å¬åˆ†è¾¨ç‡å˜åŒ–
        document.getElementById('resolution').addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                const width = prompt('è¾“å…¥å®½åº¦ï¼š', '1280');
                const height = prompt('è¾“å…¥é«˜åº¦ï¼š', '720');
                if (width && height) {
                    params.resolution = `${width}x${height}`;
                } else {
                    e.target.value = '1280x720';
                    params.resolution = '1280x720';
                }
            } else {
                params.resolution = e.target.value;
            }

            if (uploadedImage) {
                initCanvas();
                drawFrame(0);
            }
        });

        // ç›‘å¬å…¶ä»–å‚æ•°å˜åŒ–
        document.getElementById('framerate').addEventListener('change', (e) => {
            params.framerate = parseInt(e.target.value);
        });

        document.getElementById('format').addEventListener('change', (e) => {
            params.format = e.target.value;
            if (e.target.value === 'gif') {
                document.getElementById('framerate').value = '10';
                params.framerate = 10;
            }
        });

        document.getElementById('quality').addEventListener('change', (e) => {
            params.quality = e.target.value;
        });

        document.getElementById('easing').addEventListener('change', (e) => {
            params.easing = e.target.value;
            if (uploadedImage && !isPlaying) {
                drawFrame(0);
            }
        });
</script>
</body>
</html>


